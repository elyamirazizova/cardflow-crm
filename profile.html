<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardFlow - Профиль</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="api.js"></script>
    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>
</head>
<body class="bg-white">
    <custom-navbar></custom-navbar>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-8">Мой профиль</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow">
                    <div class="flex flex-col items-center mb-6">
                        <div class="w-32 h-32 rounded-full bg-purple-100 flex items-center justify-center mb-4">
                            <i data-feather="user" class="w-16 h-16 text-purple-600"></i>
                        </div>
                        <h2 id="userName" class="text-xl font-semibold">Загрузка...</h2>
                        <p id="userRole" class="text-gray-500">Загрузка...</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-1">Email</h3>
                            <p id="userEmail">Загрузка...</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-1">Телефон</h3>
                            <p id="userPhone">Загрузка...</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-1">Дата регистрации</h3>
                            <p id="userCreatedAt">Загрузка...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-semibold mb-4">Настройки профиля</h2>
                    
                    <form id="profileForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Полное имя</label>
                                <input type="text" id="fullNameInput" class="w-full p-2 border border-gray-300 rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="emailInput" class="w-full p-2 border border-gray-300 rounded">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Телефон</label>
                            <input type="tel" id="phoneInput" class="w-full p-2 border border-gray-300 rounded">
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                                Сохранить изменения
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Мои проекты</h2>
                    
                    <div id="myProjects" class="space-y-4">
                        <p class="text-gray-500">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <custom-footer></custom-footer>

    <script>
        let currentUser = null;
        let allProjects = [];

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Load user data
                currentUser = await api.getCurrentUser();
                displayUserInfo(currentUser);
                
                // Load projects
                allProjects = await api.getProjects();
                displayMyProjects();
            } catch (error) {
                console.error('Error loading profile:', error);
            }

            // Profile form submit
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                // Here would be update profile API call
                alert('Изменения сохранены!');
            });

            feather.replace();
        });

        function displayUserInfo(user) {
            document.getElementById('userName').textContent = user.full_name || user.email;
            document.getElementById('userRole').textContent = getRoleName(user.role);
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userPhone').textContent = user.phone || 'Не указан';
            document.getElementById('userCreatedAt').textContent = new Date(user.created_at).toLocaleDateString('ru-RU');
            
            document.getElementById('fullNameInput').value = user.full_name || '';
            document.getElementById('emailInput').value = user.email || '';
            document.getElementById('phoneInput').value = user.phone || '';
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'Администратор',
                'analyst': 'Аналитик',
                'user': 'Менеджер'
            };
            return roles[role] || role;
        }

        function displayMyProjects() {
            const user = JSON.parse(localStorage.getItem('user'));
            const myProjects = allProjects.filter(p => p.created_by === user.id || p.manager === user.full_name);
            
            const container = document.getElementById('myProjects');
            
            if (myProjects.length === 0) {
                container.innerHTML = '<p class="text-gray-500">У вас пока нет проектов</p>';
                return;
            }
            
            let html = '';
            myProjects.slice(0, 5).forEach(project => {
                const profit = Number(project.revenue || 0) - Number(project.expenses || 0);
                html += `
                    <div class="border-l-4 border-purple-600 p-4 bg-gray-50 rounded">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold">${project.project_name}</h3>
                            <span class="text-sm px-2 py-1 rounded ${getStatusClass(project.status)}">${getStatusText(project.status)}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${project.organization}</p>
                        <div class="flex gap-4 text-sm">
                            <span>Выручка: ${formatCurrency(project.revenue || 0)}</span>
                            <span>Прибыль: ${formatCurrency(profit)}</span>
                        </div>
                    </div>
                `;
            });
            
            if (myProjects.length > 5) {
                html += `<p class="text-gray-500 text-center mt-4">И еще ${myProjects.length - 5} проектов...</p>`;
            }
            
            container.innerHTML = html;
        }

        function getStatusText(status) {
            const map = {
                'new': 'Новый',
                'active': 'Активен',
                'in_progress': 'В работе',
                'completed': 'Завершён'
            };
            return map[status] || status;
        }

        function getStatusClass(status) {
            const map = {
                'new': 'bg-purple-100 text-purple-800',
                'active': 'bg-green-100 text-green-800',
                'in_progress': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-blue-100 text-blue-800'
            };
            return map[status] || '';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU', { 
                style: 'currency', 
                currency: 'RUB',
                minimumFractionDigits: 0 
            }).format(amount);
        }
    </script>
</body>
</html>
